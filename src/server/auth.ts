/****************************************************************************************************************************************************
 * * IMPORTS
 ****************************************************************************************************************************************************/

import { GetServerSidePropsContext } from 'next';
import { DefaultSession, NextAuthOptions, getServerSession } from 'next-auth';
import { log } from 'next-axiom';

/****************************************************************************************************************************************************
 * * TYPES - INTERFACES - CLASES
 ****************************************************************************************************************************************************/

export type Role = 'USER' | 'CLIENT' | 'ADMIN';

/****************************************************************************************************************************************************
 * * DECLARATIONS
 ****************************************************************************************************************************************************/

declare module 'next-auth' {
  interface Session extends DefaultSession {
    user: {
      id: string;
      role: Role;
      softDelete: boolean;
    } & DefaultSession['user'];
  }
  interface User {
    role: Role;
    softDelete: boolean;
  }
}

/****************************************************************************************************************************************************
 * * FUNCTIONS
 ****************************************************************************************************************************************************/

/****************************************************************************************************************************************************
 * * EXPORTS
 ****************************************************************************************************************************************************/
export const authOptions: NextAuthOptions = {
  providers: [],
  callbacks: {
    session: ({ session, user }) => ({
      ...session,
      user: {
        ...session.user,
        id: user.id,
        role: user.role,
        softDelete: user.softDelete,
      },
    }),
  },
  logger: {
    error(code, metadata) {
      log.error(code, metadata);
    },
  },
  secret: process.env.SECRET_KEY,
};

export const getServerAuthSession = (ctx: {
  req: GetServerSidePropsContext['req'];
  res: GetServerSidePropsContext['res'];
}) => {
  return getServerSession(ctx.req, ctx.res, authOptions);
};
